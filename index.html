<!-- GRK 2025-09-04: Added sequencer, removed chord -->
<!-- GRK 2025-09-03: Added configurable key mapping for keypad layouts (default and alternate with NumLock/Clear), sequencer placeholder, and UI dropdown for layout selection -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relative Keyboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen">
    <div class="p-6 bg-white rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-center mb-4">Relative Keyboard</h1>
        <p class="text-center mb-2">Current Note: None</p>
        <p class="text-center mb-2">Tonic: C4</p>
        <p class="text-center mb-2">Mode: Ionian</p>
        <p class="text-center mb-2">Intervals: 6th -1, 4th -1, 3rd -1, 2nd -1, Last Note, 2nd, 3rd, 4th, 6th</p>
        <p class="text-center mb-2">Sequencer: Stopped (16 steps, 120 BPM)</p>
        <p class="text-center mb-2">MIDI Status: Checking...</p>
        <div class="flex justify-center mb-4">
            <select id="midi-select" class="p-2 border rounded hidden">
                <option value="">Select MIDI Port</option>
            </select>
        </div>
        <div class="flex justify-center mb-4">
            <select id="tone-select" class="p-2 border rounded">
                <option value="sine">Sine Wave</option>
                <option value="organ">Organ</option>
                <option value="buzz1">Buzz1</option>
                <option value="buzz2">Buzz2</option>
                <option value="ting">Ting</option>
            </select>
        </div>
        <p class="text-center mb-4">Serve over HTTPS (e.g., Netlify) for MIDI. Use keypad or number keys 1–9 for notes (5 for last note, 2 for 6th -1, 3 for 6th -1, 1 for 3rd -1, 9 for 6th), 0 to play and reset to tonic (e.g., C4 in C major); Shift + 3–9 for modes; / + 1–7 for keys; + or keypad + to cycle tones; - or keypad - + 0 for random intervals, - + 1 for original, - + 5 for intervals with 5th; = or keypad = + 1 for +1 octave top row, = + 2 for -1 octave. For sequencer: Enter to toggle record/play, C for play/pause, D for clear; set tempo/steps with number + f + 7/8 (e.g., 160 f 7 for tempo 160).</p>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let currentKey = 0; // MIDI note offset (e.g., 0 = C)
        let currentMode = 'ionian';
        let currentTonicDegree = 0; // Tracks the degree of the current tonic relative to the root key
        let activeModeButton = null;
        let activeKeyButton = null;
        const activeOscillators = new Map(); // Tracks oscillators for sustain and polyphony
        let currentTone = 'sine'; // Default tone
        let midiOutput = null; // MIDI output device
        let keySelectionMode = null; // null, 'key', 'mode', 'interval', 'octave', 'set'
        let keySelectionTimeout = null;
        let setSelectionType = null; // 'tempo' or 'steps' for set mode
        let setValue = ''; // Buffer for set number input

        // Define modes (intervals relative to tonic in semitones)
        const modes = {
            ionian: [0, 2, 4, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            aeolian: [0, 2, 3, 5, 7, 8, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10]
        };

        // Convert MIDI note to frequency
        function midiToFreq(midiNote) {
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // Convert MIDI note to note name (e.g., 60 -> C4)
        function midiToNoteName(midiNote) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const note = noteNames[midiNote % 12];
            const octave = Math.floor(midiNote / 12) - 1;
            return `${note}${octave}`;
        }

        // Update note key labels
        function updateNoteLabels() {
            const labels = ['6th -1 (1)', '4th -1 (2)', '3rd -1 (3)', '2nd -1 (4)', 'Last Note (5)', '2nd (6)', '3rd (7)', '4th (8)', '6th (9)'];
            document.querySelectorAll('.note-key').forEach((button, index) => {
                button.textContent = labels[index];
            });
        }

        // Create a note with the selected tone
        function startNote(degree, button = null) {
            const key = button ? button.dataset.key : null;
            if (key && activeOscillators.has(key)) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // Calculate MIDI note relative to the current tonic
            const modeIntervals = modes[currentMode];
            const degreeIndex = (currentTonicDegree + degree) % 7;
            const normalizedDegreeIndex = degreeIndex >= 0 ? degreeIndex : degreeIndex + 7;
            const octaveOffset = Math.floor((currentTonicDegree + degree) / 7) * 12;
            const interval = modeIntervals[normalizedDegreeIndex];
            const midiNote = 60 + currentKey + interval + octaveOffset;

            // Ensure MIDI note is within C2 (36) to C7 (96)
            if (midiNote >= 36 && midiNote <= 96) {
                oscillator.frequency.setValueAtTime(midiToFreq(midiNote), audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                oscillator.start();

                if (key) {
                    activeOscillators.set(key, { oscillator, gainNode });
                }

                if (button) {
                    button.classList.add('bg-blue-800');
                }

                return { degree, button };
            }
            return null;
        }

        // Stop playing a note
        function stopNote(key) {
            const { oscillator, gainNode } = activeOscillators.get(key) || {};
            if (oscillator) {
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                oscillator.stop(audioCtx.currentTime + 0.1);
                activeOscillators.delete(key);

                const button = document.querySelector(`.note-key[data-key="${key}"]`);
                if (button) {
                    button.classList.remove('bg-blue-800');
                }
            }
        }

        // Update tonic after a note is played
        function updateTonic(degree) {
            currentTonicDegree += degree;
        }

        // Change mode and update button state
        function changeMode(mode, button) {
            if (activeModeButton) {
                activeModeButton.classList.remove('bg-green-700');
                activeModeButton.classList.add('bg-green-500');
            }
            button.classList.remove('bg-green-500');
            button.classList.add('bg-green-700');
            activeModeButton = button;
            currentMode = mode;
            currentTonicDegree = 0; // Reset tonic degree when mode changes
            updateNoteLabels();

            button.classList.add('bg-green-800');
            setTimeout(() => button.classList.remove('bg-green-800'), 100);
        }

        // Handle note key clicks
        document.querySelectorAll('.note-key').forEach(button => {
            button.addEventListener('mousedown', () => {
                const degree = parseInt(button.dataset.degree);
                const result = startNote(degree, button);
                if (result) {
                    updateTonic(degree);
                }
            });
            button.addEventListener('mouseup', () => {
                stopNote(button.dataset.key);
            });
        });

        // Handle mode key clicks
        document.querySelectorAll('.mode-key').forEach(button => {
            button.addEventListener('click', () => {
                changeMode(button.dataset.mode, button);
            });
        });

        // Handle key key clicks
        document.querySelectorAll('.key-key').forEach(button => {
            button.addEventListener('click', () => {
                if (activeKeyButton) {
                    activeKeyButton.classList.remove('bg-purple-700');
                    activeKeyButton.classList.add('bg-purple-500');
                }
                button.classList.remove('bg-purple-500');
                button.classList.add('bg-purple-700');
                activeKeyButton = button;
                currentKey = parseInt(button.dataset.key);
                currentTonicDegree = 0; // Reset tonic degree when key changes
                updateNoteLabels();

                button.classList.add('bg-purple-600');
                setTimeout(() => button.classList.remove('bg-purple-600'), 100);
            });
        });

        // Log all note-key data-key values for debugging
        console.log('Note keys in DOM:');
        document.querySelectorAll('.note-key').forEach(button => {
            console.log(`- data-key="${button.dataset.key}", degree=${button.dataset.degree}`);
        });

        // Keyboard input handling
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            const code = event.code;
            const shift = event.shiftKey;

            console.log(`Keydown: key=${key}, code=${code}, shift=${shift}`);

            // Note keys (using event.code)
            const noteKeyMap = {
                'Digit5': { degree: 0, buttonKey: 'r' },  // Tonic (5)
                'KeyR': { degree: 0, buttonKey: 'r' },    // Tonic (r)
                'KeyT': { degree: 0, buttonKey: 'r' },    // Tonic (t)
                'Digit2': { degree: -6, buttonKey: '2' }, // 6th -1
                'Digit3': { degree: -4, buttonKey: '3' }, // 5th -1
                'Digit4': { degree: -2, buttonKey: '4' }, // 7th
                'Digit6': { degree: 2, buttonKey: '6' },  // 2nd
                'Digit7': { degree: 4, buttonKey: '7' },  // 3rd
                'Digit8': { degree: 6, buttonKey: '8' }   // 4th
            };

            // Mode keys (using event.key)
            const modeKeyMap = {
                '#': 'ionian',
                '$': 'dorian',
                '^': 'phrygian',
                '%': 'lydian',
                '&': 'mixolydian',
                '*': 'aeolian',
                '(': 'locrian'
            };

            if (!shift && noteKeyMap[code]) {
                console.log(`Note key matched: code=${code}, degree=${noteKeyMap[code].degree}, buttonKey=${noteKeyMap[code].buttonKey}`);
                const query = `.note-key[data-key="${noteKeyMap[code].buttonKey}"]`;
                console.log(`Querying: ${query}`);
                const button = document.querySelector(query) || document.querySelector('.note-key[data-degree="0"]');
                if (button) {
                    console.log(`Button found for data-key="${noteKeyMap[code].buttonKey}"`);
                    const degree = parseInt(button.dataset.degree);
                    startNote(degree, button);
                } else {
                    console.log(`No button found for query: ${query}`);
                }
            } else if (shift && modeKeyMap[key]) {
                console.log(`Mode key matched: key=${key}, mode=${modeKeyMap[key]}`);
                const button = document.querySelector(`.mode-key[data-key="${key}"]`);
                if (button) {
                    changeMode(button.dataset.mode, button);
                } else {
                    console.log(`No mode button found for data-key="${key}"`);
                }
            }
        });

        document.addEventListener('keyup', (event) => {
            const key = event.key;
            const code = event.code;

            console.log(`Keyup: key=${key}, code=${code}`);

            const noteKeyMap = {
                'Digit5': { degree: 0, buttonKey: 'r' },
                'KeyR': { degree: 0, buttonKey: 'r' },
                'KeyT': { degree: 0, buttonKey: 'r' },
                'Digit2': { degree: -6, buttonKey: '2' },
                'Digit3': { degree: -4, buttonKey: '3' },
                'Digit4': { degree: -2, buttonKey: '4' },
                'Digit6': { degree: 2, buttonKey: '6' },
                'Digit7': { degree: 4, buttonKey: '7' },
                'Digit8': { degree: 6, buttonKey: '8' }
            };

            if (noteKeyMap[code]) {
                console.log(`Stopping note for code=${code}, buttonKey=${noteKeyMap[code].buttonKey}`);
                const button = document.querySelector(`.note-key[data-key="${noteKeyMap[code].buttonKey}"]`);
                if (button && activeOscillators.has(noteKeyMap[code].buttonKey)) {
                    const degree = parseInt(button.dataset.degree);
                    stopNote(noteKeyMap[code].buttonKey);
                    updateTonic(degree);
                }
            }
        });

        // Initialize with Ionian mode and C key selected
        const initModeButton = document.querySelector('.mode-key[data-mode="ionian"]');
        initModeButton.classList.remove('bg-green-500');
        initModeButton.classList.add('bg-green-700');
        activeModeButton = initModeButton;

        const initKeyButton = document.querySelector('.key-key[data-key="0"]');
        initKeyButton.classList.remove('bg-purple-500');
        initKeyButton.classList.add('bg-purple-700');
        activeKeyButton = initKeyButton;

        // Initialize note labels
        updateNoteLabels();
    </script>
</body>
</html>
    </script>
</body>
</html>
